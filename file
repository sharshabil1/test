; =============================================================
; Project: 2-Digit Scrolling Counter for PmodSSD
; Hardware: 8086 Trainer with 8255 PPI
; Connection: 
;   - Port A (0FFE0H) -> Segments (AA-AG)
;   - Port C (0FFE4H) -> Digit Select (CAT Pin connected to PC0)
; =============================================================

ORG 2000H           ; Executable starts at memory location 2000H
    JMP START

; --- DATA TABLE ---
; 7-Segment Codes (Common Cathode)
; 0=3FH, 1=06H, 2=5BH, 3=4FH, 4=66H, 5=6DH, Blank=00H
CODES:  DB 00H      ; Index 0: Blank 
        DB 06H      ; Index 1: '1'
        DB 5BH      ; Index 2: '2'
        DB 4FH      ; Index 3: '3'
        DB 66H      ; Index 4: '4'
        DB 6DH      ; Index 5: '5'
        DB 00H      ; Index 6: Blank 

; --- MAIN PROGRAM ---
START:
    ; 1. Initialize 8255 PPI
    MOV DX, 0FFE6H  ; Control Word Register
    MOV AL, 80H     ; Port A=Out, Port B=Out, Port C=Out
    OUT DX, AL

MAIN_LOOP:
    ; Fix for Line 35 Error: Use MOV immediate for address, not LEA
    MOV SI, CODES   ; Point SI to the start of the CODES table [cite: 47]
    MOV CX, 6       ; Loop counter for the scrolling sequence

SCROLL_SEQ:
    PUSH CX         ; Save loop counter

    ; Fetch the two digits
    ; Fix for "Invalid Operand": Explicitly tell NASM these are BYTES
    MOV AL, BYTE [SI]    ; Load Left Digit code
    MOV BL, BYTE [SI+1]  ; Load Right Digit code
    
    ; Display Loop (Multiplexing)
    MOV CX, 50      ; Speed of scroll (Higher = Slower)

DISPLAY_FRAME:
    CALL MULTIPLEX
    LOOP DISPLAY_FRAME

    POP CX          ; Restore loop counter
    INC SI          ; Move to next number in the table
    LOOP SCROLL_SEQ 

    JMP MAIN_LOOP   ; Repeat forever

; --- SUBROUTINE: MULTIPLEX ---
; Rapidly switches between Left (AL) and Right (BL) digits
MULTIPLEX:
    PUSH AX
    PUSH DX

    ; 1. DISPLAY LEFT DIGIT
    ; Select Left Digit (PC0 = 0)
    MOV DX, 0FFE4H  ; Port C Address
    MOV AL, 00H     ; Bit 0 Low
    OUT DX, AL      
    
    ; Send Data to Segments
    MOV DX, 0FFE0H  ; Port A Address
    POP AX          ; Retrieve original AX (with AL/BL data)
    PUSH AX         ; Put it back on stack
    OUT DX, AL      ; Send Left Digit Code
    
    CALL DELAY_SMALL

    ; 2. DISPLAY RIGHT DIGIT
    ; Select Right Digit (PC0 = 1)
    MOV DX, 0FFE4H  ; Port C Address
    MOV AL, 01H     ; Bit 0 High
    OUT DX, AL      
    
    ; Send Data to Segments
    MOV DX, 0FFE0H  ; Port A Address
    MOV AL, BL      ; Move Right Digit Code (BL) to AL
    OUT DX, AL      ; Send Right Digit Code
    
    CALL DELAY_SMALL

    POP DX
    POP AX
    RET

; --- SUBROUTINE: DELAY ---
DELAY_SMALL:
    PUSH CX
    MOV CX, 0100H   ; Adjust for flicker-free display
WAIT_LOOP:
    LOOP WAIT_LOOP
    POP CX
    RET
